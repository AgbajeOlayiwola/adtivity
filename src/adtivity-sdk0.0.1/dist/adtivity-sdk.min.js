!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).Adtivity={})}(this,function(t){"use strict";function e(t,e,i){const n=window.location.pathname+window.location.search;i._lastTrackedPage!==n?(i._lastTrackedPage=n,t("Page Viewed",{pageTitle:document.title,path:window.location.pathname,query:window.location.search,fullUrl:window.location.href}).catch(t=>e("error","Error tracking automatic page view:",t))):e("debug","Page URL unchanged, skipping duplicate page view tracking.")}function i(t){try{localStorage.removeItem(t)}catch(e){console.warn(`[Adtivity SDK] Failed to remove localStorage item '${t}':`,e)}}class n{constructor(t){this._config={apiKey:null,apiBaseUrl:"https://api.adtivity.com/v1",debug:!1,batchSize:10,flushInterval:5e3,maxRetries:3,retryDelayMs:1e3,collectData:!0},this._eventQueue=[],this._flushTimer=null,this._lastTrackedPage=null,n._isInitialized?this._log("warn","Adtivity SDK already initialized. Subsequent initializations will be ignored."):t&&t.apiKey?(this._config={...this._config,...t},n._isInitialized=!0,this._log("info","Adtivity SDK initialized successfully.",this._config),this._loadPersistedEvents(),this._startFlushTimer(),this._processDeferredCalls(),document.addEventListener("visibilitychange",()=>{"hidden"===document.visibilityState&&this.flushEvents(!0)}),window.addEventListener("beforeunload",()=>this.flushEvents(!0)),window.addEventListener("unload",()=>this.flushEvents(!0))):console.error("Adtivity SDK Error: API Key is required for initialization.")}static getInstance(t){return n._instance||(n._instance=new n(t)),n._instance}_log(t){if(this._config.debug||"error"===t||"warn"===t){for(var e=arguments.length,i=new Array(e>1?e-1:0),n=1;n<e;n++)i[n-1]=arguments[n];console[t]("[Adtivity SDK]",...i)}}_persistEvents(){try{!function(t,e){try{localStorage.setItem(t,e)}catch(e){console.warn(`[Adtivity SDK] Failed to set localStorage item '${t}':`,e)}}("adtivity_event_queue",JSON.stringify(this._eventQueue)),this._log("debug",`Persisted ${this._eventQueue.length} events to local storage.`)}catch(t){this._log("error","Failed to persist events to local storage:",t)}}_loadPersistedEvents(){try{const t=function(t){try{return localStorage.getItem(t)}catch(e){return console.warn(`[Adtivity SDK] Failed to get localStorage item '${t}':`,e),null}}("adtivity_event_queue");t&&(this._eventQueue=JSON.parse(t),this._log("info",`Loaded ${this._eventQueue.length} events from local storage.`),i("adtivity_event_queue"))}catch(t){this._log("error","Failed to load persisted events from local storage:",t),i("adtivity_event_queue")}}_startFlushTimer(){this._flushTimer&&clearInterval(this._flushTimer),this._flushTimer=window.setInterval(()=>{this._eventQueue.length>0&&(this._log("debug","Flushing events due to interval."),this.flushEvents())},this._config.flushInterval),this._log("debug",`Flush timer started for every ${this._config.flushInterval}ms.`)}async _sendBatch(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;if(!this._config.apiKey)return this._log("error","API Key is missing. Please ensure SDK is initialized with a valid API Key."),Promise.reject(new Error("API Key missing"));const i=`${this._config.apiBaseUrl}/events`;try{this._log("debug",`Sending batch of ${t.length} events. Attempt ${e+1}.`,t);const n=await fetch(i,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${this._config.apiKey}`},body:JSON.stringify(t),keepalive:!0});if(!n.ok){const t=await n.json().catch(()=>({message:"Unknown error"}));throw new Error(`API Error (${n.status}): ${n.statusText} - ${t.message||JSON.stringify(t)}`)}return this._log("info",`Successfully sent batch of ${t.length} events.`),n.json()}catch(i){if(this._log("error",`Failed to send batch (Attempt ${e+1}):`,i),e<this._config.maxRetries){const i=this._config.retryDelayMs*Math.pow(2,e);return this._log("info",`Retrying in ${i}ms...`),await new Promise(t=>setTimeout(t,i)),this._sendBatch(t,e+1)}throw this._log("error","Max retries reached. Dropping batch or re-queueing (not implemented for simplicity)."),i}}_queueEvent(t){this._config.collectData?(this._eventQueue.push(t),this._log("debug",`Event queued. Queue size: ${this._eventQueue.length}.`,t),this._eventQueue.length>=this._config.batchSize?(this._log("debug","Batch size met. Flushing events."),this.flushEvents()):this._startFlushTimer(),this._persistEvents()):this._log("debug","Data collection disabled. Event not queued.")}async flushEvents(){let t=arguments.length>0&&void 0!==arguments[0]&&arguments[0];if(0===this._eventQueue.length)return void this._log("debug","No events to flush.");this._flushTimer&&(clearInterval(this._flushTimer),this._flushTimer=null);const e=[...this._eventQueue];this._eventQueue=[];try{await this._sendBatch(e),i("adtivity_event_queue")}catch(i){this._log("error","Error flushing events. Events might be re-queued or lost.",i),t?this._log("warn","Events likely lost during unload due to send failure:",e):(this._eventQueue.unshift(...e),this._persistEvents())}finally{!t&&this._eventQueue.length>0&&this._startFlushTimer()}}trackEvent(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if(!n._isInitialized)return this._log("warn","SDK not initialized. Deferring event:",t),void n._deferredCalls.push(["trackEvent",t,e]);if(!this._config.collectData)return void this._log("debug",`Event '${t}' not tracked due to consent settings.`);const i={eventName:t,properties:{...e,timestamp:(new Date).toISOString(),url:window.location.href,referrer:document.referrer,userAgent:navigator.userAgent,sessionId:this._getSessionId(),anonymousId:this._getAnonymousId()}};this._queueEvent(i)}async identify(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if(!n._isInitialized)return this._log("warn","SDK not initialized. Deferring identify call:",t),void n._deferredCalls.push(["identify",t,e]);if(!this._config.collectData)return void this._log("debug",`User identification for '${t}' skipped due to consent settings.`);if(!t)return void this._log("error","User ID is required for identification.");const i={userId:t,properties:{...e,lastSeen:(new Date).toISOString()}};try{const e={type:"identify",anonymousId:this._getAnonymousId(),userId:t,properties:i.properties,timestamp:(new Date).toISOString()};await this._sendBatch([e])}catch(e){this._log("error",`Failed to send identify call for user ${t}:`,e)}}setConsent(t){this._config.collectData=t,this._log("info",`Adtivity SDK data collection consent set to: ${t}`),t?(this._startFlushTimer(),this._loadPersistedEvents()):(this.flushEvents(),this._eventQueue=[],i("adtivity_event_queue"),this._flushTimer&&(clearInterval(this._flushTimer),this._flushTimer=null),this._log("info","All data collection stopped and cleared."))}_processDeferredCalls(){if(n._deferredCalls.length>0)for(this._log("info",`Processing ${n._deferredCalls.length} deferred calls.`);n._deferredCalls.length>0;){const[t,...e]=n._deferredCalls.shift();"function"==typeof this[t]?this[t](...e):this._log("warn",`Deferred call to unknown method: ${t}`)}}initAutomaticPageTracking(){this._config.collectData?(!function(t,i,n){e(t,i,n);const s=history.pushState;history.pushState=function(){for(var r=arguments.length,a=new Array(r),o=0;o<r;o++)a[o]=arguments[o];s.apply(history,a),e(t,i,n)};const r=history.replaceState;history.replaceState=function(){for(var s=arguments.length,a=new Array(s),o=0;o<s;o++)a[o]=arguments[o];r.apply(history,a),e(t,i,n)},window.addEventListener("popstate",()=>{e(t,i,n)}),i("info","Automatic page view tracking listeners attached.")}((t,e)=>this.trackEvent(t,e),this._log,this),this._log("info","Automatic page view tracking initialized.")):this._log("debug","Automatic page tracking skipped due to consent settings.")}initAutomaticClickTracking(){var t,e;this._config.collectData?(t=(t,e)=>this.trackEvent(t,e),e=this._log,document.body.addEventListener("click",i=>{const n=i.target.closest("[data-adtivity-track]");if(n){const i=n.getAttribute("data-adtivity-track")||"Automatic Click";let s={elementId:n.id||null,elementText:n.innerText?n.innerText.substring(0,200):null,elementType:n.tagName,href:n.href||null,type:n.type||null,value:n.value||null,className:n.className||null};if(n.dataset.adtivityProps)try{const t=JSON.parse(n.dataset.adtivityProps);s={...s,...t}}catch(t){e("error","Failed to parse data-adtivity-props. Ensure it is valid JSON:",t,n.dataset.adtivityProps)}t(i,s).catch(t=>e("error","Error tracking automatic click:",t))}}),e("info","Automatic click tracking listeners attached."),this._log("info","Automatic click tracking initialized.")):this._log("debug","Automatic click tracking skipped due to consent settings.")}static __resetForTesting(){n._isInitialized=!1,n._instance=null,n._deferredCalls=[]}}n._isInitialized=!1,n._instance=null,n._deferredCalls=[],window.Adtivity=window.Adtivity||{trackEvent:function(){for(var t=arguments.length,e=new Array(t),i=0;i<t;i++)e[i]=arguments[i];return n._deferredCalls.push(["trackEvent",...e])},identify:function(){for(var t=arguments.length,e=new Array(t),i=0;i<t;i++)e[i]=arguments[i];return n._deferredCalls.push(["identify",...e])},setConsent:function(){for(var t=arguments.length,e=new Array(t),i=0;i<t;i++)e[i]=arguments[i];return n._deferredCalls.push(["setConsent",...e])},getInstance:t=>n.getInstance(t)},document.addEventListener("DOMContentLoaded",()=>{const t=window.Adtivity.getInstance(window.adtivityConfig||{apiKey:"YOUR_DEFAULT_OR_FALLBACK_API_KEY",debug:!0});t.initAutomaticPageTracking(),t.initAutomaticClickTracking()}),"complete"!==document.readyState||n._isInitialized||window.Adtivity.getInstance(window.adtivityConfig||{apiKey:"YOUR_DEFAULT_OR_FALLBACK_API_KEY",debug:!0}),t.Adtivity=n});
//# sourceMappingURL=adtivity-sdk.min.js.map
